<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Safety Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
<div class="container">
    <header>
        <h1>QR Code Safety Scanner</h1>
        <p>Upload any QR code to analyze its safety before scanning</p>
    </header>

    <div class="scanner-box">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì∑</div>
            <p>Drag & Drop QR Code Image or Click to Browse</p>
            <input type="file" id="qrInput" accept="image/*" hidden>
            <button class="btn" id="chooseFileBtn">Choose File</button>
            <p id="fileName" class="file-name">No file selected</p>
        </div>

        <button class="btn analyze-btn" id="analyzeBtn" disabled>Analyze QR Code</button>

        <div id="result" class="result-box"></div>
    </div>

    <footer>
        <p>¬© 2025 QR Safety Scanner | Protecting users from malicious QR codes</p>
    </footer>
</div>

<script>
    const chooseFileBtn = document.getElementById("chooseFileBtn");
    const qrInput = document.getElementById("qrInput");
    const fileName = document.getElementById("fileName");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultDiv = document.getElementById("result");

    let selectedFile = null;

    chooseFileBtn.addEventListener("click", () => qrInput.click());

    qrInput.addEventListener("change", function(e) {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            fileName.textContent = "Selected: " + selectedFile.name;
            analyzeBtn.disabled = false;
        } else {
            fileName.textContent = "No file selected";
            analyzeBtn.disabled = true;
        }
    });

    analyzeBtn.addEventListener("click", function() {
        if (!selectedFile) return;

        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                fetch("/process-qr", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: code.data })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        resultDiv.className = "result-box valid";
                        resultDiv.innerHTML = `
                            <h3>‚úÖ Safe QR Code</h3>
                            <pre>${JSON.stringify(data.data, null, 2)}</pre>
                        `;
                    } else {
                        resultDiv.className = "result-box invalid";
                        resultDiv.innerHTML = `<h3>‚ùå ${data.message}</h3>`;
                    }
                });
            } else {
                resultDiv.className = "result-box invalid";
                resultDiv.innerHTML = "<h3>‚ùå Could not detect QR Code</h3>";
            }
        };
        img.src = URL.createObjectURL(selectedFile);
    });
</script>
</body>
</html>
